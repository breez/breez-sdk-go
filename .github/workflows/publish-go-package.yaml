name: Publish Go Bindings
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'breez-sdk repo release (MAJOR.MINOR.PATCH)'
        required: true
        type: string

jobs:
  build-tag-release:
    name: Build, tag, and release the Breez SDK Go bindings
    runs-on: macOS-latest
    steps:
      - name: Install required dependencies
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
        run: |
          brew tap messense/macos-cross-toolchains
          brew install protobuf
          brew install aarch64-unknown-linux-gnu
          brew install x86_64-unknown-linux-gnu
          brew install mingw-w64
          cargo install --version 0.22.0 uniffi_bindgen
      - name: Checkout breez-sdk repo
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository_owner }}/breez-sdk
          path: build
          ref: ${{ inputs.version }}
      - name: Checkout breez-sdk-go repo
        uses: actions/checkout@v3
        with:
          path: dist
      - name: Build Go bindings
        working-directory: build/libs/sdk-bindings
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: x86_64-linux-gnu-gcc
          SSH_PRIVATE_KEY: ${{secrets.REPO_SSH_KEY}}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          sudo chmod 600 ~/.ssh/id_rsa
          ssh-add ~/.ssh/id_rsa
          make init
          rustup target add x86_64-pc-windows-gnu
          cargo build --release --target aarch64-unknown-linux-gnu
          cargo build --release --target x86_64-unknown-linux-gnu
          cargo build --release --target x86_64-pc-windows-gnu
          make golang-darwin
      - name: Copy binding
        working-directory: build/libs/sdk-bindings/ffi/golang/breez/breez_sdk
        run: |
          cp breez_sdk.go ../../../../../../../dist/breez_sdk
      - name: Copy libraries
        working-directory: build/libs/target
        run: |
          cp aarch64-apple-darwin/release/libbreez_sdk_bindings.dylib ../../../dist/breez_sdk/lib/darwin-aarch64
          cp x86_64-apple-darwin/release/libbreez_sdk_bindings.dylib ../../../dist/breez_sdk/lib/darwin-amd64
          cp aarch64-unknown-linux-gnu/release/libbreez_sdk_bindings.so ../../../dist/breez_sdk/lib/linux-aarch64
          cp x86_64-unknown-linux-gnu/release/libbreez_sdk_bindings.so ../../../dist/breez_sdk/lib/linux-amd64
          cp x86_64-pc-windows-gnu/release/breez_sdk_bindings.dll ../../../dist/breez_sdk/lib/windows-amd64
      - name: Tag the Go bindings
        working-directory: dist
        run: |
          git add breez_sdk/breez_sdk.go
          git add breez_sdk/lib/darwin-aarch64/libbreez_sdk_bindings.dylib
          git add breez_sdk/lib/darwin-amd64/libbreez_sdk_bindings.dylib
          git add breez_sdk/lib/linux-aarch64/libbreez_sdk_bindings.so
          git add breez_sdk/lib/linux-amd64/libbreez_sdk_bindings.so
          git add breez_sdk/lib/windows-amd64/breez_sdk_bindings.dll
          git commit -m "Update Breez SDK Go bindings to version ${{ inputs.version }}"
          git push
          git tag ${{ inputs.version }} -m "${{ inputs.version }}"
          git push --tags
